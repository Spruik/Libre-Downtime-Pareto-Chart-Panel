{"version":3,"sources":["../src/chart_ctrl.js"],"names":["angular","moment","_","$","dp","pie","utils","echarts","MetricsPanelCtrl","panelDefaults","targets","pageSize","showHeader","styles","columns","fontSize","ChartCtrl","$scope","$injector","templateSrv","annotationsSrv","$sanitize","variableSrv","pageIndex","panel","fields","defaults","events","on","onDataReceived","bind","onDataError","hasData","datasource","transform","setTimeQueryStart","getAnnotations","dashboard","range","then","annotations","data","err","dataRaw","render","dataList","length","undefined","type","console","log","restructuredData","rows","calcDurationInt","getCategories","durationint","_to","to","isAfter","_prevTime","i","item","diff","time","duration","valueOf","globe_data","scope","elem","attrs","ctrl","$panelContainer","find","myChart","init","renderPanel","option","getOption","off","setOption","setTimeout","height","resize","window","onresize","p","seriesType","seriesName","legend","series","name","xAxis","toolbox","feature","myTool1","show","reasons","getReasonsData","checkIsDurationMode","sortedReasons","sortMax","sortedReasonsLabel","filterItems","sortedReasonsValue","sortedReasonsPercent","accumulatePercentages","totalVal","reduce","total","val","yAxis","max","durationTotal","renderingCompleted","templateUrl"],"mappings":"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","file":"chart_ctrl.js","sourcesContent":["import angular from 'angular';\nimport moment from 'moment';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport * as dp from './data_processor';\nimport * as pie from './pie_chart_option';\nimport * as utils from './utils';\nimport echarts from './libs/echarts.min';\nimport { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport './css/style.css!';\nimport './css/bootstrap-slider.css!';\n\nconst panelDefaults = {\n\ttargets: [ {} ],\n\tpageSize: null,\n\tshowHeader: true,\n\tstyles: [],\n\tcolumns: [],\n\tfontSize: '100%'\n};\n\nexport class ChartCtrl extends MetricsPanelCtrl {\n\tconstructor($scope, $injector, templateSrv, annotationsSrv, $sanitize, variableSrv) {\n\t\tsuper($scope, $injector);\n\n\t\tthis.pageIndex = 0;\n\n\t\tif (this.panel.styles === void 0) {\n\t\t\tthis.panel.styles = this.panel.columns;\n\t\t\tthis.panel.columns = this.panel.fields;\n\t\t\tdelete this.panel.columns;\n\t\t\tdelete this.panel.fields;\n\t\t}\n\n\t\t_.defaults(this.panel, panelDefaults);\n\n\t\tthis.events.on('data-received', this.onDataReceived.bind(this));\n\t\tthis.events.on('data-error', this.onDataError.bind(this));\n\t\tthis.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n\n\t\tthis.hasData = false;\n\t}\n\n\tissueQueries(datasource) {\n\t\tthis.pageIndex = 0;\n\n\t\tif (this.panel.transform === 'annotations') {\n\t\t\tthis.setTimeQueryStart();\n\t\t\treturn this.annotationsSrv\n\t\t\t\t.getAnnotations({\n\t\t\t\t\tdashboard: this.dashboard,\n\t\t\t\t\tpanel: this.panel,\n\t\t\t\t\trange: this.range\n\t\t\t\t})\n\t\t\t\t.then((annotations) => {\n\t\t\t\t\treturn { data: annotations };\n\t\t\t\t});\n\t\t}\n\n\t\treturn super.issueQueries(datasource);\n\t}\n\n\tonDataError(err) {\n\t\tthis.dataRaw = [];\n\t\tthis.render();\n\t}\n\n\tonDataReceived(dataList) {\n\t\tif (dataList.length === 0 || dataList === null || dataList === undefined) {\n\t\t\t// console.log('No data reveived')\n\t\t\tthis.hasData = false;\n\t\t\treturn;\n\t\t} else {\n\t\t\tthis.hasData = true;\n\t\t}\n\n\t\tif (dataList[0].type !== 'table') {\n\t\t\tconsole.log('To show the pie chart, please format data as a TABLE in the Metrics Setting');\n\t\t\treturn;\n\t\t}\n\n\t\t//dataList data is messy and with lots of unwanted data, so we need to filter out data that we want -\n\t\tlet data = dp.restructuredData(dataList[0].columns, dataList[0].rows);\n\n\t\t//Calc durationint\n\t\tdata = this.calcDurationInt(data);\n\n\t\tif (dp.getCategories(data).length === 0) {\n\t\t\tthis.hasData = false;\n\t\t\treturn;\n\t\t}\n\n\t\tthis.render(data);\n\t}\n\n\tcalcDurationInt(data) {\n\t\tif (!data[0].durationint) {\n\t\t\tconst _to = this.range.to.isAfter(moment()) ? moment() : this.range.to;\n\t\t\tlet _prevTime = null;\n\t\t\tfor (let i = data.length - 1; i >= 0; i--) {\n\t\t\t\tconst item = data[i];\n\t\t\t\tif (i === data.length - 1) {\n\t\t\t\t\t// first one\n\t\t\t\t\tconst diff = _to.diff(moment(item.time));\n\t\t\t\t\tconst duration = moment.duration(diff);\n\t\t\t\t\titem.durationint = duration.valueOf();\n\t\t\t\t} else {\n\t\t\t\t\tconst diff = _prevTime.diff(item.time);\n\t\t\t\t\tconst duration = moment.duration(diff);\n\t\t\t\t\titem.durationint = duration.valueOf();\n\t\t\t\t}\n\t\t\t\t_prevTime = moment(item.time);\n\t\t\t}\n\t\t}\n\t\treturn data;\n\t}\n\n\trendering() {\n\t\tthis.render(this.globe_data);\n\t}\n\n\tlink(scope, elem, attrs, ctrl) {\n\t\tconst $panelContainer = elem.find('#reason-codes-pareto-chart')[0];\n\t\tconst myChart = echarts.init($panelContainer);\n\n\t\tfunction renderPanel(data) {\n\t\t\tif (!myChart || !data) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst option = pie.getOption(data, myChart);\n\n\t\t\tmyChart.off('click');\n\t\t\tmyChart.setOption(option);\n\t\t\tsetTimeout(() => {\n\t\t\t\t$('#reason-codes-pareto-chart').height(ctrl.height - 51);\n\t\t\t\tmyChart.resize();\n\t\t\t\twindow.onresize = () => {\n\t\t\t\t\tmyChart.resize();\n\t\t\t\t};\n\t\t\t}, 500);\n\t\t\tmyChart.on('click', (p) => {\n\t\t\t\tif (p.seriesType === 'bar' && p.seriesName !== 'Reasons') {\n\t\t\t\t\toption.legend.data[0] = 'Reasons';\n\t\t\t\t\toption.series[0].name = 'Reasons';\n\t\t\t\t\toption.xAxis[0].name = 'Category: ' + p.name;\n\t\t\t\t\toption.toolbox.feature.myTool1.show = true;\n\t\t\t\t\tlet reasons = dp.getReasonsData(p.name, data);\n\n\t\t\t\t\tif (!pie.checkIsDurationMode()) {\n\t\t\t\t\t\t//get reasons\n\t\t\t\t\t\tlet sortedReasons = dp.sortMax(reasons, 'value');\n\t\t\t\t\t\t//get reason label\n\t\t\t\t\t\tlet sortedReasonsLabel = dp.filterItems(sortedReasons, 'name');\n\t\t\t\t\t\t//get reason value\n\t\t\t\t\t\tlet sortedReasonsValue = dp.filterItems(sortedReasons, 'value');\n\t\t\t\t\t\t//get reason percent\n\t\t\t\t\t\tlet sortedReasonsPercent = dp.filterItems(sortedReasons, 'percent');\n\t\t\t\t\t\tsortedReasonsPercent = dp.accumulatePercentages(sortedReasonsPercent);\n\t\t\t\t\t\t//get total value\n\t\t\t\t\t\tlet totalVal = sortedReasonsValue.reduce((total, val) => total + val);\n\n\t\t\t\t\t\toption.series[0].data = sortedReasonsValue;\n\t\t\t\t\t\toption.xAxis[0].data = sortedReasonsLabel;\n\t\t\t\t\t\toption.series[1].data = sortedReasonsPercent;\n\t\t\t\t\t\toption.yAxis[0].max = totalVal;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlet sortedReasons = dp.sortMax(reasons, 'duration');\n\t\t\t\t\t\tlet sortedReasonsLabel = dp.filterItems(sortedReasons, 'name');\n\t\t\t\t\t\tlet sortedReasonsValue = dp.filterItems(sortedReasons, 'duration');\n\t\t\t\t\t\tlet sortedReasonsPercent = dp.filterItems(sortedReasons, 'dur-p');\n\t\t\t\t\t\tsortedReasonsPercent = dp.accumulatePercentages(sortedReasonsPercent);\n\n\t\t\t\t\t\toption.series[0].data = sortedReasonsValue;\n\t\t\t\t\t\toption.xAxis[0].data = sortedReasonsLabel;\n\t\t\t\t\t\toption.series[1].data = sortedReasonsPercent;\n\t\t\t\t\t\toption.yAxis[0].max = sortedReasons[0].durationTotal;\n\t\t\t\t\t}\n\n\t\t\t\t\tmyChart.setOption(option);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tctrl.events.on('panel-size-changed', () => {\n\t\t\tif (myChart) {\n\t\t\t\tconst height = ctrl.height - 51;\n\t\t\t\tif (height >= 280) {\n\t\t\t\t\t$('#reason-codes-pareto-chart').height(height);\n\t\t\t\t}\n\t\t\t\tmyChart.resize();\n\t\t\t}\n\t\t});\n\n\t\tctrl.events.on('render', (data) => {\n\t\t\trenderPanel(data);\n\t\t\tctrl.renderingCompleted();\n\t\t});\n\t}\n}\n\nChartCtrl.templateUrl = 'partials/module.html';\n"]}